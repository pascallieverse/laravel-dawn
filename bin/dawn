#!/usr/bin/env php
<?php

/**
 * Dawn â€” Platform-detecting wrapper script.
 *
 * Detects the current OS and architecture, then executes the
 * appropriate pre-compiled Rust binary from the same directory.
 */

$binDir = __DIR__;

// Detect OS
$os = PHP_OS_FAMILY;
switch ($os) {
    case 'Darwin':
        $platform = 'darwin';
        break;
    case 'Linux':
        $platform = 'linux';
        break;
    case 'Windows':
        $platform = 'windows';
        break;
    default:
        fwrite(STDERR, "Dawn: Unsupported operating system: {$os}\n");
        exit(1);
}

// Detect architecture
$machine = php_uname('m');
switch ($machine) {
    case 'arm64':
    case 'aarch64':
        $arch = 'arm64';
        break;
    case 'x86_64':
    case 'amd64':
        $arch = 'x64';
        break;
    default:
        fwrite(STDERR, "Dawn: Unsupported architecture: {$machine}\n");
        exit(1);
}

// Build binary path
$ext = $platform === 'windows' ? '.exe' : '';
$binary = "{$binDir}/dawn-{$platform}-{$arch}{$ext}";

if (! file_exists($binary)) {
    fwrite(STDERR, "Dawn: Binary not found for {$platform}-{$arch}: {$binary}\n");
    fwrite(STDERR, "Available binaries:\n");
    foreach (glob("{$binDir}/dawn-*") as $file) {
        fwrite(STDERR, "  " . basename($file) . "\n");
    }
    exit(1);
}

// Ensure binary is executable (Composer doesn't preserve permissions)
if (! is_executable($binary)) {
    chmod($binary, 0755);
}

// Forward all arguments
$args = array_slice($argv, 1);

// Prefer pcntl_exec for true process replacement (no extra PHP process)
if (function_exists('pcntl_exec')) {
    pcntl_exec($binary, $args);
    // pcntl_exec only returns on failure
    fwrite(STDERR, "Dawn: pcntl_exec failed for {$binary}\n");
    exit(1);
}

// Fallback: passthru (keeps PHP process alive as parent)
$command = escapeshellarg($binary);
foreach ($args as $arg) {
    $command .= ' ' . escapeshellarg($arg);
}

passthru($command, $exitCode);
exit($exitCode);
